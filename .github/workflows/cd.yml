name: CD - Continuous Deployment

# Trigger deployment on successful CI and when pushing tags
on:
  push:
    tags:
      - 'v*'  # Trigger on version tags like v1.0.0
  workflow_run:
    workflows: ["CI - Continuous Integration"]
    branches: [main]
    types: 
      - completed

jobs:
  deploy:
    name: Deploy Application
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-cov
        
    - name: Run final tests before deployment
      run: |
        python -m unittest test_app.py -v
        
    - name: Build application package
      run: |
        # Create a simple distribution directory
        mkdir -p dist
        cp app.py dist/
        cp test_app.py dist/
        echo "Application built successfully" > dist/BUILD_INFO.txt
        echo "Build Date: $(date)" >> dist/BUILD_INFO.txt
        echo "Git Commit: ${{ github.sha }}" >> dist/BUILD_INFO.txt
        
    - name: Archive production artifacts
      uses: actions/upload-artifact@v3
      with:
        name: python-app-${{ github.sha }}
        path: |
          dist/
          !dist/**/*.pyc
          
    - name: Create Release (on tag push)
      if: startsWith(github.ref, 'refs/tags/')
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref_name }}
        release_name: Release ${{ github.ref_name }}
        body: |
          ## Changes in this Release
          - Automated release from CI/CD pipeline
          - Tested on multiple Python versions (3.8-3.12)
          - All tests passing âœ…
          
          ## Files
          - `app.py` - Main calculator application
          - `test_app.py` - Comprehensive test suite
          
        draft: false
        prerelease: false
        
    # Example deployment to a staging environment
    - name: Deploy to Staging
      run: |
        echo "ðŸš€ Deploying to staging environment..."
        echo "Application URL: https://staging.example.com"
        echo "Deployment completed successfully!"
        
    # Uncomment and configure for actual deployment
    # - name: Deploy to Production Server
    #   if: startsWith(github.ref, 'refs/tags/')
    #   run: |
    #     # Add your deployment commands here
    #     # Examples: Docker push, SSH deploy, cloud deployment, etc.
    #     echo "Deploying to production..."